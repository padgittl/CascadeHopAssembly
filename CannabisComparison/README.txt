# Align hop and cannabis gene sequences to UniProt Embryophyta genes

blastp –query hopGeneModels.pep.fasta –db embryophytaUniprot.fasta -evalue 1e-5 -outfmt '6 std qcovs' -out hop_vs_uniprot.txt
blastp –query embryophytaUniprot.fasta –db hopGeneModels.pep.fasta -evalue 1e-5 -outfmt '6 std qcovs' -out uniprot_vs_hop.txt

blastp –query cs10.protein_coding.2905.PEP.fasta –db embryophytaUniprot.fasta -evalue 1e-5 -outfmt '6 std qcovs' -out cannabis_vs_uniprot.txt
blastp –query embryophytaUniprot.fasta –db cs10.protein_coding.2905.PEP.fasta -evalue 1e-5 -outfmt '6 std qcovs' -out uniprot_vs_cannabis.txt

##################################
##### getHopGeneModelSeqs.py #####
##################################

python getHopGeneModelSeqs.py hopGeneModels.pep.fasta hop_vs_uniprot.txt uniprot_vs_hop.txt uniprotEmbryophyta.fasta

# output file --> hopHits.fasta

#######################################
##### getCannabisGeneModelSeqs.py #####
#######################################

python getCannabisGeneModelSeqs.py cannabisGeneModels.pep.fasta cannabis_vs_uniprot.txt uniprot_vs_cannabis.txt uniprotEmbryophyta.fasta

# output file --> cannabisHits.fasta

##### concatenate hit fasta files --> 
cat hopHits.fasta cannabisHits.fasta > allHits.fasta

##### run clustalw2

clustalw2 -infile=allHits.fasta -type=PROTEIN -outfile=allHits.aln > allHits.clustalw2.out

##### run trimal

trimal -in allHits.aln -gappyout > allHits_noGaps.aln

##### convert to phylip format

>>> from Bio import AlignIO
>>> alignment = AlignIO.parse("allHits_noGaps.aln","clustal")
>>> AlignIO.write(alignment,open("allHits_noGaps.phy","w"),"phylip-relaxed")

##### run phyml

phyml -i allHits_noGaps.phy -d aa -m Blosum62 -c 4 -a e

# output files --> allHits_noGaps.phy_phyml_stats.txt // allHits_noGaps.phy_phyml_tree.txt

##### create tree with createTree.py --> details in directory 'Figure4_Synteny/'

################################################################################

##### identify mutual best hits (MBH)

# align hop and cannabis top hits to each other
blastp -query hopHits.fasta -db cannabisHits.fasta -evalue 1e-5 -outfmt '6 std qcovs' -out hop_vs_cannabis.txt
blastp -query cannabisHits.fasta -db hopHits.fasta -evalue 1e-5 -outfmt '6 std qcovs' -out cannabis_vs_hop.txt

#####################
##### getMBH.py #####
#####################

python getMBH.py hop_vs_cannabis.txt cannabis_vs_hop.txt > MBH.txt


############################
## SUPPLEMENTARY FIGURE 8 ##
############################

# this figure shows the density of uniprot hit copy numbers between hop and cannabis

# first, get the top uniprot hits to hop and cannabis in both directions

####################
## hopBestHits.py ##
####################

python hopBestHits.py hop_vs_uniprot.txt uniprot_vs_hop.txt > hopTopHits.txt

## hop_vs_uniprot.txt and uniprot_vs_hop.txt generated by running blastp -->
# blastp -query hopGenes.fasta -db uniprotEmbryophytaGenes.fasta -evalue 1e-5 -outfmt '6 std qcovs' -out hop_vs_uniprot.txt
# blastp -query uniprotEmbryophytaGenes.fasta -db hopGenes.fasta -evalue 1e-5 -outfmt '6 std qcovs' -out uniprot_vs_hop.txt

#########################
## cannabisBestHits.py ##
#########################

python cannabisBestHits.py cannabis_vs_uniprot.txt uniprot_vs_cannabis.txt > cannabisTopHits.txt

## cannabis_vs_uniprot.txt and uniprot_vs_cannabis.txt generated by running blastp --> 
# blastp -query cs10.protein_coding.2905.PEP.fasta -db uniprotEmbryophytaGenes.fasta -evalue 1e-5 -outfmt '6 std qcovs' -out cannabis_vs_uniprot.txt
# blastp -query uniprotEmbryophytaGenes.fasta -db cs10.protein_coding.2905.PEP.fasta -evalue 1e-5 -outfmt '6 std qcovs' -out uniprot_vs_cannabis.txt

#############################
## hop_vs_cannabis_hist.py ##
#############################

python hop_vs_cannabis_hist.py hopTopHits.txt cannabisTopHits.txt hopCascadeGeneModels.gff cs10.protein_coding.2905.gff3 uniprotEmbryophytaGenes.fasta hopGenesWithBacteriaHomologyQueryCoverage75.txt > uniprotGeneCounts.txt

python hop_vs_cannabis_hist_zoom.py hopTopHits.txt cannabisTopHits.txt hopCascadeGeneModels.gff cs10.protein_coding.2905.gff3 uniprotEmbryophytaGenes.fasta hopGenesWithBacteriaHomologyQueryCoverage75.txt > uniprotGeneCounts.txt

# cs10.protein_coding.2905.gff3 obtained from http://cannabisgenome.org/

# uniprotEmbryophytaGenes.fasta contains a set of 37364 plant genes from uniprot

# see directory FilterGeneModels for details about how to obtain hopGenesWithBacteriaHomologyQueryCoverage75.txt, which contains IDs for genes that have homology to only bacteria uniprot genes

